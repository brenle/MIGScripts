<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Validate-AdaptiveScopesOPATHQuery.ps1 - MIGScripts</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Validate-AdaptiveScopesOPATHQuery.ps1";
        var mkdocs_page_input_path = "exo\\validate-adaptivescopesopathquery.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> MIGScripts
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Exchange</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Validate-AdaptiveScopesOPATHQuery.ps1</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#requirements">Requirements</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#to-run-the-script-and-enter-an-opath-query-using-a-gui">To run the script and enter an OPATH query using a GUI</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#to-run-the-script-and-extract-an-opath-query-from-an-existing-scope">To run the script and extract an OPATH query from an existing scope</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#to-run-the-script-and-supply-a-query-via-parameter">To run the script and supply a query via parameter</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#optional-parameters">Optional parameters</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#known-limitations">Known Limitations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#screenshots">Screenshots</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#download">Download</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#changelog">Changelog</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#april-19th-2022-6681d82">April 19th, 2022 (6681d82)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#april-1st-2022-70213d8">April 1st, 2022 (70213d8)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#january-18th-2022-92cf440">January 18th, 2022 (92cf440)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#january-11th-2022-47823d2">January 11th, 2022 (47823d2)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#january-5th-2022-39ad9d4">January 5th, 2022 (39ad9d4)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#november-7th-2021-6d829d5">November 7th, 2021 (6d829d5)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#november-4th-2021-6c5e7c0">November 4th, 2021 (6c5e7c0)</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">SharePoint/OneDrive</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../spo-od/adaptive-scopes-propertybag-scripts/">Adaptive Scopes Property Bag Scripts</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="https://github.com/brenle/MIGScripts/issues">⚠️ Submit an issue</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">MIGScripts</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Exchange &raquo;</li><li>Validate-AdaptiveScopesOPATHQuery.ps1</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="validate-adaptivescopesopathqueryps1">Validate-AdaptiveScopesOPATHQuery.ps1<a class="headerlink" href="#validate-adaptivescopesopathqueryps1" title="Permanent link">⚓︎</a></h1>
<p>This script can be used to validate advanced adaptive scopes queries written in OPATH.</p>
<h2 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">⚓︎</a></h2>
<ul>
<li>Ensure you've read the <a href="https://brenle.github.io/MIGScripts/#disclaimer">disclaimer</a> and <a href="https://brenle.github.io/MIGScripts/#running-the-scripts">running the scripts</a> sections of this documentation.</li>
<li>To run this script, you must have the <a href="https://docs.microsoft.com/en-us/powershell/exchange/exchange-online-powershell-v2?view=exchange-ps#install-and-maintain-the-exo-v2-module">Exchange Online PowerShell module</a> installed.</li>
<li>You will be required to at least connect to Exchange Online, and will need permissions that allow you to run <code>Get-Mailbox</code> and <code>Get-Recipient</code>.</li>
<li>To connect to Exchange Online using the Exchange Online PowerShell module, run:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">Connect-ExchangeOnline</span>
</code></pre></div>
<ul>
<li>If you use <code>-adaptiveScopeName</code> you will also need to connect to Security and Compliance Center PowerShell, and will need permissions that allow ou to run <code>Get-AdaptiveScope</code>.</li>
<li>To connect to the Security and Compliance Center PowerShell module, run:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">Connect-IPPSSession</span>
</code></pre></div>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">⚓︎</a></h2>
<h5 id="to-run-the-script-and-enter-an-opath-query-using-a-gui">To run the script and enter an OPATH query using a GUI<a class="headerlink" href="#to-run-the-script-and-enter-an-opath-query-using-a-gui" title="Permanent link">⚓︎</a></h5>
<div class="highlight"><pre><span></span><code><span class="p">.\</span><span class="n">Validate-AdaptiveScopesOPATHQuery</span><span class="p">.</span><span class="n">ps1</span>
</code></pre></div>
<h5 id="to-run-the-script-and-extract-an-opath-query-from-an-existing-scope">To run the script and extract an OPATH query from an existing scope<a class="headerlink" href="#to-run-the-script-and-extract-an-opath-query-from-an-existing-scope" title="Permanent link">⚓︎</a></h5>
<div class="highlight"><pre><span></span><code><span class="p">.\</span><span class="n">Validate-AdaptiveScopesOPATHQuery</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-adaptiveScopeName</span> <span class="no">[name of scope]</span>
</code></pre></div>
<h5 id="to-run-the-script-and-supply-a-query-via-parameter">To run the script and supply a query via parameter<a class="headerlink" href="#to-run-the-script-and-supply-a-query-via-parameter" title="Permanent link">⚓︎</a></h5>
<div class="highlight"><pre><span></span><code><span class="p">.\</span><span class="n">Validate-AdaptiveScopesOPATHQuery</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-rawQuery</span> <span class="no">[OPATH query]</span> <span class="n">-scopeType</span> <span class="p">[</span><span class="n">User</span> <span class="p">|</span> <span class="n">Group</span><span class="p">]</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You must include <code>-scopeType</code> when using <code>-rawQuery</code></p>
</div>
<h3 id="optional-parameters">Optional parameters<a class="headerlink" href="#optional-parameters" title="Permanent link">⚓︎</a></h3>
<ul>
<li><code>-exportCSV</code>: Exports full output of objects that match OPATH query to CSV file. No value is required with this parameter.</li>
<li><code>-csvPath [path]</code>: Path to export Csv.  Default value is c:\temp\</li>
</ul>
<h2 id="known-limitations">Known Limitations<a class="headerlink" href="#known-limitations" title="Permanent link">⚓︎</a></h2>
<ul>
<li>Some properties exist for <code>Get-Mailbox</code> and some for <code>Get-Recipient</code>.  The script attempts to see if the query works with <code>Get-Mailbox</code> first, then attempts to use <code>Get-Recipient</code>.  However, if properties are mixed (one that works only with <code>Get-Mailbox</code> and one that works only with <code>Get-Recipient</code>), the script will not be able to validate the query although mixing properties is supported with adaptive policy scopes.  Review which cmdlet each property works with <a href="https://aka.ms/opath-filter">here</a>.</li>
</ul>
<h2 id="screenshots">Screenshots<a class="headerlink" href="#screenshots" title="Permanent link">⚓︎</a></h2>
<figure>
    <img src="../img/validation-script-no-params.png"/> 
    <figcaption style="font-style: italic; text-align:center;">Figure 1: Executing Validate-AdaptiveScopesOPATHQuery.ps1 with no parameters.</figcaption>
</figure>

<p><br/></p>
<figure>
    <img src="../img/validation-script-result.png"/> 
    <figcaption style="font-style: italic; text-align:center;">Figure 2: Validate-AdaptiveScopesOPATHQuery.ps1 results.</figcaption>
</figure>

<h2 id="download">Download<a class="headerlink" href="#download" title="Permanent link">⚓︎</a></h2>
<p>Access the script <a href="https://github.com/brenle/MIGScripts/blob/main/Exchange/Validate-AdaptiveScopesOPATHQuery.ps1">here</a></p>
<h2 id="changelog">Changelog<a class="headerlink" href="#changelog" title="Permanent link">⚓︎</a></h2>
<h5 id="april-19th-2022-6681d82">April 19th, 2022 <a href="https://github.com/brenle/MIGScripts/commit/6681d82436e1b0bf0e85ff85f20db0cd72ca6274">(6681d82)</a><a class="headerlink" href="#april-19th-2022-6681d82" title="Permanent link">⚓︎</a></h5>
<ul>
<li>Added support for user shards. These are on prem users that have no license assigned and no mailbox exists in onprem or in EXO.  As an example, service accounts. These are usually not used but they are included in adaptive scopes, so for validation we want to count them.  To identify these types of users in your environment, run the following in EXO PS:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">Get-User</span> <span class="n">-RecipientTypeDetails</span> <span class="n">User</span> <span class="n">-ResultSize</span> <span class="n">Unlimited</span>
</code></pre></div>
<h5 id="april-1st-2022-70213d8">April 1st, 2022 <a href="https://github.com/brenle/MIGScripts/commit/70213d8e125f433e752b148c8428e30257ad6a9e">(70213d8)</a><a class="headerlink" href="#april-1st-2022-70213d8" title="Permanent link">⚓︎</a></h5>
<ul>
<li>Added <code>skipMixedPropertyDetection</code> and set it to default to True because it needs to be rewritten as it was causing issues</li>
</ul>
<h5 id="january-18th-2022-92cf440">January 18th, 2022 <a href="https://github.com/brenle/MIGScripts/commit/92cf4409115b932bf3445785f2d1db9eb33fae98">(92cf440)</a><a class="headerlink" href="#january-18th-2022-92cf440" title="Permanent link">⚓︎</a></h5>
<ul>
<li>Added <code>skipQuickValidation</code> switch which will skip entirely the quick validation check (which looks for common mistakes)</li>
</ul>
<h5 id="january-11th-2022-47823d2">January 11th, 2022 <a href="https://github.com/brenle/MIGScripts/commit/47823d2a7238fc6636324aa2c22bdc58fb87c6c4">(47823d2)</a><a class="headerlink" href="#january-11th-2022-47823d2" title="Permanent link">⚓︎</a></h5>
<ul>
<li>Added support for on-prem users in hybrid environment (MailUser)</li>
<li>Added warning for inactive mailboxes discovered by Get-Recipient</li>
<li>Added quick validation for mixed properties</li>
</ul>
<h5 id="january-5th-2022-39ad9d4">January 5th, 2022 <a href="https://github.com/brenle/MIGScripts/commit/39ad9d4f80599c69a99318b28aa01ad421d87482">(39ad9d4)</a><a class="headerlink" href="#january-5th-2022-39ad9d4" title="Permanent link">⚓︎</a></h5>
<ul>
<li>Added support for SharedMailbox, EquipmentMailbox and RoomMailbox recipient types</li>
<li>Rewrote analysis to provide stats for number of shared/resource mailboxes in addition to inactive/incorrectly licensed</li>
</ul>
<h5 id="november-7th-2021-6d829d5">November 7th, 2021 <a href="https://github.com/brenle/MIGScripts/commit/6d829d5acf12f5b3a8e43383089106ff2c3b4d51">(6d829d5)</a><a class="headerlink" href="#november-7th-2021-6d829d5" title="Permanent link">⚓︎</a></h5>
<ul>
<li>Updated documentation link</li>
<li>Improved detection of inactive mailboxes</li>
<li>Added total number of inactive mailboxes in query because of improvements</li>
<li>Added detection of improperly licensed users (<strong>Experimental!</strong> <em>This may incorrectly report depending on the license or add-on</em>)</li>
</ul>
<h5 id="november-4th-2021-6c5e7c0">November 4th, 2021 <a href="https://github.com/brenle/MIGScripts/commit/6c5e7c01c9815d189eda8b81e3ee5a0933477c8d">(6c5e7c0)</a><a class="headerlink" href="#november-4th-2021-6c5e7c0" title="Permanent link">⚓︎</a></h5>
<ul>
<li>Initial release</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../.." class="btn btn-neutral float-left" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../spo-od/adaptive-scopes-propertybag-scripts/" class="btn btn-neutral float-right" title="Adaptive Scopes Property Bag Scripts">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../.." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../spo-od/adaptive-scopes-propertybag-scripts/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
