{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Welcome to MIGScripts \u2693\ufe0e An assortment of scripts which I've created to help with Microsoft Information Governance (MIG) and Records Management (RM) scenarios. Disclaimer \u2693\ufe0e These scripts are provided as working (usually) examples , as-is, with no support . However, if you do find an issue with any of theses scripts, feel free to submit an issue or fork and submit a pull request with any updates. Use these scripts at your own risk . Ensure you review the entire script and understand exactly what it does before using. Test the scripts within a demo tenant or test environment before using in production. Warning I am not responsible for any negative result from using these scripts. It is your responsibility to fully review and understand what the script will do before running in your environment. Running the scripts \u2693\ufe0e Given the scripts connect to resources in Microsoft 365, most of these scripts will require some prerequisite modules, such as: Exchange Online PowerShell module SharePoint Online PowerShell module PnP PowerShell module I will note what is required and/or optional for each script. Since the scripts are meant to be simple examples and not production scripts, I do not sign my scripts. In order to run these scripts, you will need to set the execution policy to unrestricted within PowerShell on your machine: Set-ExecutionPolicy Unrestricted Additionally, if you download any script from the internet and attempt to run it, you will first need to unblock the file first. Unblock-File < filename >","title":"Home"},{"location":"#welcome-to-migscripts","text":"An assortment of scripts which I've created to help with Microsoft Information Governance (MIG) and Records Management (RM) scenarios.","title":"Welcome to MIGScripts"},{"location":"#disclaimer","text":"These scripts are provided as working (usually) examples , as-is, with no support . However, if you do find an issue with any of theses scripts, feel free to submit an issue or fork and submit a pull request with any updates. Use these scripts at your own risk . Ensure you review the entire script and understand exactly what it does before using. Test the scripts within a demo tenant or test environment before using in production. Warning I am not responsible for any negative result from using these scripts. It is your responsibility to fully review and understand what the script will do before running in your environment.","title":"Disclaimer"},{"location":"#running-the-scripts","text":"Given the scripts connect to resources in Microsoft 365, most of these scripts will require some prerequisite modules, such as: Exchange Online PowerShell module SharePoint Online PowerShell module PnP PowerShell module I will note what is required and/or optional for each script. Since the scripts are meant to be simple examples and not production scripts, I do not sign my scripts. In order to run these scripts, you will need to set the execution policy to unrestricted within PowerShell on your machine: Set-ExecutionPolicy Unrestricted Additionally, if you download any script from the internet and attempt to run it, you will first need to unblock the file first. Unblock-File < filename >","title":"Running the scripts"},{"location":"exo/validate-adaptivescopesopathquery/","text":"Validate-AdaptiveScopesOPATHQuery.ps1 \u2693\ufe0e This script can be used to validate advanced adaptive scopes queries written in OPATH. Requirements \u2693\ufe0e Ensure you've read the disclaimer and running the scripts sections of this documentation. To run this script, you must have the Exchange Online PowerShell module installed. You will be required to at least connect to Exchange Online, and will need permissions that allow you to run Get-Mailbox and Get-Recipient . To connect to Exchange Online using the Exchange Online PowerShell module, run: Connect-ExchangeOnline If you use -adaptiveScopeName you will also need to connect to Security and Compliance Center PowerShell, and will need permissions that allow ou to run Get-AdaptiveScope . To connect to the Security and Compliance Center PowerShell module, run: Connect-IPPSSession Usage \u2693\ufe0e To run the script and enter an OPATH query using a GUI \u2693\ufe0e .\\ Validate-AdaptiveScopesOPATHQuery . ps1 To run the script and extract an OPATH query from an existing scope \u2693\ufe0e .\\ Validate-AdaptiveScopesOPATHQuery . ps1 -adaptiveScopeName [name of scope] To run the script and supply a query via parameter \u2693\ufe0e .\\ Validate-AdaptiveScopesOPATHQuery . ps1 -rawQuery [OPATH query] -scopeType [ User | Group ] Note You must include -scopeType when using -rawQuery Optional parameters \u2693\ufe0e -exportCSV : Exports full output of objects that match OPATH query to CSV file. No value is required with this parameter. -csvPath [path] : Path to export Csv. Default value is c:\\temp\\ Known Limitations \u2693\ufe0e Some properties exist for Get-Mailbox and some for Get-Recipient . The script attempts to see if the query works with Get-Mailbox first, then attempts to use Get-Recipient . However, if properties are mixed (one that works only with Get-Mailbox and one that works only with Get-Recipient ), the script will not be able to validate the query although mixing properties is supported with adaptive policy scopes. Review which cmdlet each property works with here . Screenshots \u2693\ufe0e Figure 1: Executing Validate-AdaptiveScopesOPATHQuery.ps1 with no parameters. Figure 2: Validate-AdaptiveScopesOPATHQuery.ps1 results. Download \u2693\ufe0e Access the script here Changelog \u2693\ufe0e April 20th, 2022 (0f1348c) \u2693\ufe0e Fixed bug where GuestMailUser objects would appear. These objects will not show in an adaptive scope and are not supported for retention policies. Rearranged output to improve readability April 19th, 2022 (6681d82) \u2693\ufe0e Added support for user shards. These are on prem users that have no license assigned and no mailbox exists in onprem or in EXO. As an example, service accounts. These are usually not used but they are included in adaptive scopes, so for validation we want to count them. To identify these types of users in your environment, run the following in EXO PS: Get-User -RecipientTypeDetails User -ResultSize Unlimited April 1st, 2022 (70213d8) \u2693\ufe0e Added -skipMixedPropertyDetection and set it to default to True because it needs to be rewritten as it was causing issues January 18th, 2022 (92cf440) \u2693\ufe0e Added -skipQuickValidation switch which will skip entirely the quick validation check (which looks for common mistakes) January 11th, 2022 (47823d2) \u2693\ufe0e Added support for on-prem users in hybrid environment (MailUser) Added warning for inactive mailboxes discovered by Get-Recipient Added quick validation for mixed properties January 5th, 2022 (39ad9d4) \u2693\ufe0e Added support for SharedMailbox, EquipmentMailbox and RoomMailbox recipient types Rewrote analysis to provide stats for number of shared/resource mailboxes in addition to inactive/incorrectly licensed November 7th, 2021 (6d829d5) \u2693\ufe0e Updated documentation link Improved detection of inactive mailboxes Added total number of inactive mailboxes in query because of improvements Added detection of improperly licensed users ( Experimental! This may incorrectly report depending on the license or add-on ) November 4th, 2021 (6c5e7c0) \u2693\ufe0e Initial release","title":"Validate-AdaptiveScopesOPATHQuery.ps1"},{"location":"exo/validate-adaptivescopesopathquery/#validate-adaptivescopesopathqueryps1","text":"This script can be used to validate advanced adaptive scopes queries written in OPATH.","title":"Validate-AdaptiveScopesOPATHQuery.ps1"},{"location":"exo/validate-adaptivescopesopathquery/#requirements","text":"Ensure you've read the disclaimer and running the scripts sections of this documentation. To run this script, you must have the Exchange Online PowerShell module installed. You will be required to at least connect to Exchange Online, and will need permissions that allow you to run Get-Mailbox and Get-Recipient . To connect to Exchange Online using the Exchange Online PowerShell module, run: Connect-ExchangeOnline If you use -adaptiveScopeName you will also need to connect to Security and Compliance Center PowerShell, and will need permissions that allow ou to run Get-AdaptiveScope . To connect to the Security and Compliance Center PowerShell module, run: Connect-IPPSSession","title":"Requirements"},{"location":"exo/validate-adaptivescopesopathquery/#usage","text":"","title":"Usage"},{"location":"exo/validate-adaptivescopesopathquery/#to-run-the-script-and-enter-an-opath-query-using-a-gui","text":".\\ Validate-AdaptiveScopesOPATHQuery . ps1","title":"To run the script and enter an OPATH query using a GUI"},{"location":"exo/validate-adaptivescopesopathquery/#to-run-the-script-and-extract-an-opath-query-from-an-existing-scope","text":".\\ Validate-AdaptiveScopesOPATHQuery . ps1 -adaptiveScopeName [name of scope]","title":"To run the script and extract an OPATH query from an existing scope"},{"location":"exo/validate-adaptivescopesopathquery/#to-run-the-script-and-supply-a-query-via-parameter","text":".\\ Validate-AdaptiveScopesOPATHQuery . ps1 -rawQuery [OPATH query] -scopeType [ User | Group ] Note You must include -scopeType when using -rawQuery","title":"To run the script and supply a query via parameter"},{"location":"exo/validate-adaptivescopesopathquery/#optional-parameters","text":"-exportCSV : Exports full output of objects that match OPATH query to CSV file. No value is required with this parameter. -csvPath [path] : Path to export Csv. Default value is c:\\temp\\","title":"Optional parameters"},{"location":"exo/validate-adaptivescopesopathquery/#known-limitations","text":"Some properties exist for Get-Mailbox and some for Get-Recipient . The script attempts to see if the query works with Get-Mailbox first, then attempts to use Get-Recipient . However, if properties are mixed (one that works only with Get-Mailbox and one that works only with Get-Recipient ), the script will not be able to validate the query although mixing properties is supported with adaptive policy scopes. Review which cmdlet each property works with here .","title":"Known Limitations"},{"location":"exo/validate-adaptivescopesopathquery/#screenshots","text":"Figure 1: Executing Validate-AdaptiveScopesOPATHQuery.ps1 with no parameters. Figure 2: Validate-AdaptiveScopesOPATHQuery.ps1 results.","title":"Screenshots"},{"location":"exo/validate-adaptivescopesopathquery/#download","text":"Access the script here","title":"Download"},{"location":"exo/validate-adaptivescopesopathquery/#changelog","text":"","title":"Changelog"},{"location":"exo/validate-adaptivescopesopathquery/#april-20th-2022-0f1348c","text":"Fixed bug where GuestMailUser objects would appear. These objects will not show in an adaptive scope and are not supported for retention policies. Rearranged output to improve readability","title":"April 20th, 2022 (0f1348c)"},{"location":"exo/validate-adaptivescopesopathquery/#april-19th-2022-6681d82","text":"Added support for user shards. These are on prem users that have no license assigned and no mailbox exists in onprem or in EXO. As an example, service accounts. These are usually not used but they are included in adaptive scopes, so for validation we want to count them. To identify these types of users in your environment, run the following in EXO PS: Get-User -RecipientTypeDetails User -ResultSize Unlimited","title":"April 19th, 2022 (6681d82)"},{"location":"exo/validate-adaptivescopesopathquery/#april-1st-2022-70213d8","text":"Added -skipMixedPropertyDetection and set it to default to True because it needs to be rewritten as it was causing issues","title":"April 1st, 2022 (70213d8)"},{"location":"exo/validate-adaptivescopesopathquery/#january-18th-2022-92cf440","text":"Added -skipQuickValidation switch which will skip entirely the quick validation check (which looks for common mistakes)","title":"January 18th, 2022 (92cf440)"},{"location":"exo/validate-adaptivescopesopathquery/#january-11th-2022-47823d2","text":"Added support for on-prem users in hybrid environment (MailUser) Added warning for inactive mailboxes discovered by Get-Recipient Added quick validation for mixed properties","title":"January 11th, 2022 (47823d2)"},{"location":"exo/validate-adaptivescopesopathquery/#january-5th-2022-39ad9d4","text":"Added support for SharedMailbox, EquipmentMailbox and RoomMailbox recipient types Rewrote analysis to provide stats for number of shared/resource mailboxes in addition to inactive/incorrectly licensed","title":"January 5th, 2022 (39ad9d4)"},{"location":"exo/validate-adaptivescopesopathquery/#november-7th-2021-6d829d5","text":"Updated documentation link Improved detection of inactive mailboxes Added total number of inactive mailboxes in query because of improvements Added detection of improperly licensed users ( Experimental! This may incorrectly report depending on the license or add-on )","title":"November 7th, 2021 (6d829d5)"},{"location":"exo/validate-adaptivescopesopathquery/#november-4th-2021-6c5e7c0","text":"Initial release","title":"November 4th, 2021 (6c5e7c0)"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/","text":"Adaptive Scopes Property Bag Scripts \u2693\ufe0e These scripts are to be used as examples showing how you can use SharePoint Patterns & Practices (PnP) to add custom properties to a large number of existing sites in SharePoint Online. Requirements \u2693\ufe0e Ensure you've read the disclaimer and running the scripts sections of this documentation. For the first script ( Export-SPOSites.ps1 ) you will be required to connect to SharePoint Online using the SharePoint Online PowerShell Module and will need permissions that allow you to run Get-SPOSite : For the second script ( Add-BulkPropertyBagValues.ps1 ) you will be required to use PnP.PowerShell module and will need to be a site collection administrator for each site you want to add custom properties to. If this is the first time you are using PnP PowerShell, you will need to first log in interactively and allow permissions: Connect-PnPOnline -Url https ://{ tenantName }. sharepoint . com / sites /{ sitename } -Interactive Figure 1: When first using PnP PowerShell you must accept the AAD permissions by logging in with the -Interactive switch. Since the purpose of these scripts are to update many existing SharePoint Online sites, you must save your credentials (at least temporarily) in the credential manager. Follow these instructions to do so. Note This method only works with Windows. There are other methods available, but you will need to update the scripts to use them. Some optional parameters may require connectivity to the Exchange Online PowerShell module and will require permissions to run Get-UnifiedGroup . Usage \u2693\ufe0e Step 1: Export the existing sites \u2693\ufe0e Log in to SharePoint Online PowerShell Connect-SPOService -Url https ://{ tenantName } -admin . sharepoint . com Use Export-SPOSites.ps1 to export all SPO sites to a CSV file. Use -customKeyToAdd to provide the name of the custom property you will be adding to all sites. .\\ Export-SPOSites . ps1 -customKeyToAdd customKeyName Note Replace customKeyName with whatever custom key name you want to use, such as customDepartment or customProjectName . All sites that the script exports will be stored in a CSV file. The location will be output once the script is completed. Note The default location and name of the CSV file will be c:\\temp\\SPOSitesExport.csv . You can use optional parameters to change the default location and name. Figure 2: Using Export-SPOSites. Step 2: Add a property bag value for each site in the CSV file \u2693\ufe0e Open the CSV file that was created. A column for the custom property you specified with the -customKeyToAdd switch has been added. Add a value in this column for each site that you want to add the custom property to, then save the CSV file. Note Any site that you add a value for will be processed. Any site that you do not add a value for will be skipped. In this example, 4 sites have values set so only 4 sites will be updated. Figure 3: Specifying the custom property values. Step 3: Update the property bag for each site \u2693\ufe0e Execute Add-BulkPropertyBagValues.ps1 using -customKeyToAdd to specify the name of the custom property added in the previous steps, -csvFile to provide the path to the CSV file updated in the previous steps, and -storedCredential to provide the credential stored in the credential manager . This script will automatically connect to each site and add the new custom properties. Note Unless optional parameters are specified, the script will default to not overwriting custom property values if the properties already exist. .\\ Add-BulkPropertyBagValues . ps1 -customKeyToAdd \"customKeyName\" -csvFile c :\\ temp \\ SPOSitesExport . csv -storedCredential PropertyBagExample Figure 4: Add-BulkPropertyBagValues.ps1 will give a status bar as it is running giving an indication as to how many sites were completed, skipped, and failed. Figure 5: Add-BulkPropertyBagValues.ps1 will give a status report after running indicating how many sites were completed, skipped, and failed. Optional parameters \u2693\ufe0e Export-SPOSites.ps1 \u2693\ufe0e customValueToAdd : You can alternatively have the script automatically populate custom values in the CSV. Keep in mind this will apply to ALL exported sites. csvExportPath : Path to export CSV. Default is c:\\temp. csvExportFileName : Name of CSV file. Default is SPOSitesExport.csv. identifyTeamsConnectedGroups : When enabled, will connect to EXO to identify which M365 groups are teams. Default is disabled ( $false ). Enabling this parameter will require connection to Exchange Online PowerShell . outputAllAvailableSPOSiteProperties : when enabled, the script will not limit output columns. when disabled, only select columns are output. Default is disabled ( $false ). The following parameters are optional but cannot be combined with each other \u2693\ufe0e TeamsConnectedGroupsOnly : Outputs only M365 groups which are Teams connected. Enabling this parameter will require connection to Exchange Online PowerShell . Default is disabled ( $false ). M365GroupsOnly : Outputs only M365 groups. If identifyTeamsConnectedGroups is enabled, it will output non-Teams M365 groups. Default is disabled ( $false ). SPOSitesOnly : Outputs only SPO Sites (non-Group connected). Default is disabled ( $false ). Update-BulkPropertyBagValues.ps1 \u2693\ufe0e overwrite : If enabled, the script will overwrite any existing property bag values that match the custom property being added. Default is disabled ( $false ). Download \u2693\ufe0e Export-SPOSites.ps1 Add-BulkPropertyBagValues.ps1 Changelog \u2693\ufe0e Export-SPOSites.ps1 \u2693\ufe0e October 27, 2021 (0586751) \u2693\ufe0e Initial release Update-BulkPropertyBagValues.ps1 \u2693\ufe0e January 14, 2022 (8394ccd) \u2693\ufe0e Updated with new PnP cmdlet and module version check October 27, 2021 (0586751) \u2693\ufe0e Initial release","title":"Adaptive Scopes Property Bag Scripts"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#adaptive-scopes-property-bag-scripts","text":"These scripts are to be used as examples showing how you can use SharePoint Patterns & Practices (PnP) to add custom properties to a large number of existing sites in SharePoint Online.","title":"Adaptive Scopes Property Bag Scripts"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#requirements","text":"Ensure you've read the disclaimer and running the scripts sections of this documentation. For the first script ( Export-SPOSites.ps1 ) you will be required to connect to SharePoint Online using the SharePoint Online PowerShell Module and will need permissions that allow you to run Get-SPOSite : For the second script ( Add-BulkPropertyBagValues.ps1 ) you will be required to use PnP.PowerShell module and will need to be a site collection administrator for each site you want to add custom properties to. If this is the first time you are using PnP PowerShell, you will need to first log in interactively and allow permissions: Connect-PnPOnline -Url https ://{ tenantName }. sharepoint . com / sites /{ sitename } -Interactive Figure 1: When first using PnP PowerShell you must accept the AAD permissions by logging in with the -Interactive switch. Since the purpose of these scripts are to update many existing SharePoint Online sites, you must save your credentials (at least temporarily) in the credential manager. Follow these instructions to do so. Note This method only works with Windows. There are other methods available, but you will need to update the scripts to use them. Some optional parameters may require connectivity to the Exchange Online PowerShell module and will require permissions to run Get-UnifiedGroup .","title":"Requirements"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#usage","text":"","title":"Usage"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#step-1-export-the-existing-sites","text":"Log in to SharePoint Online PowerShell Connect-SPOService -Url https ://{ tenantName } -admin . sharepoint . com Use Export-SPOSites.ps1 to export all SPO sites to a CSV file. Use -customKeyToAdd to provide the name of the custom property you will be adding to all sites. .\\ Export-SPOSites . ps1 -customKeyToAdd customKeyName Note Replace customKeyName with whatever custom key name you want to use, such as customDepartment or customProjectName . All sites that the script exports will be stored in a CSV file. The location will be output once the script is completed. Note The default location and name of the CSV file will be c:\\temp\\SPOSitesExport.csv . You can use optional parameters to change the default location and name. Figure 2: Using Export-SPOSites.","title":"Step 1: Export the existing sites"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#step-2-add-a-property-bag-value-for-each-site-in-the-csv-file","text":"Open the CSV file that was created. A column for the custom property you specified with the -customKeyToAdd switch has been added. Add a value in this column for each site that you want to add the custom property to, then save the CSV file. Note Any site that you add a value for will be processed. Any site that you do not add a value for will be skipped. In this example, 4 sites have values set so only 4 sites will be updated. Figure 3: Specifying the custom property values.","title":"Step 2: Add a property bag value for each site in the CSV file"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#step-3-update-the-property-bag-for-each-site","text":"Execute Add-BulkPropertyBagValues.ps1 using -customKeyToAdd to specify the name of the custom property added in the previous steps, -csvFile to provide the path to the CSV file updated in the previous steps, and -storedCredential to provide the credential stored in the credential manager . This script will automatically connect to each site and add the new custom properties. Note Unless optional parameters are specified, the script will default to not overwriting custom property values if the properties already exist. .\\ Add-BulkPropertyBagValues . ps1 -customKeyToAdd \"customKeyName\" -csvFile c :\\ temp \\ SPOSitesExport . csv -storedCredential PropertyBagExample Figure 4: Add-BulkPropertyBagValues.ps1 will give a status bar as it is running giving an indication as to how many sites were completed, skipped, and failed. Figure 5: Add-BulkPropertyBagValues.ps1 will give a status report after running indicating how many sites were completed, skipped, and failed.","title":"Step 3: Update the property bag for each site"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#optional-parameters","text":"","title":"Optional parameters"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#export-spositesps1","text":"customValueToAdd : You can alternatively have the script automatically populate custom values in the CSV. Keep in mind this will apply to ALL exported sites. csvExportPath : Path to export CSV. Default is c:\\temp. csvExportFileName : Name of CSV file. Default is SPOSitesExport.csv. identifyTeamsConnectedGroups : When enabled, will connect to EXO to identify which M365 groups are teams. Default is disabled ( $false ). Enabling this parameter will require connection to Exchange Online PowerShell . outputAllAvailableSPOSiteProperties : when enabled, the script will not limit output columns. when disabled, only select columns are output. Default is disabled ( $false ).","title":"Export-SPOSites.ps1"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#the-following-parameters-are-optional-but-cannot-be-combined-with-each-other","text":"TeamsConnectedGroupsOnly : Outputs only M365 groups which are Teams connected. Enabling this parameter will require connection to Exchange Online PowerShell . Default is disabled ( $false ). M365GroupsOnly : Outputs only M365 groups. If identifyTeamsConnectedGroups is enabled, it will output non-Teams M365 groups. Default is disabled ( $false ). SPOSitesOnly : Outputs only SPO Sites (non-Group connected). Default is disabled ( $false ).","title":"The following parameters are optional but cannot be combined with each other"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#update-bulkpropertybagvaluesps1","text":"overwrite : If enabled, the script will overwrite any existing property bag values that match the custom property being added. Default is disabled ( $false ).","title":"Update-BulkPropertyBagValues.ps1"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#download","text":"Export-SPOSites.ps1 Add-BulkPropertyBagValues.ps1","title":"Download"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#changelog","text":"","title":"Changelog"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#export-spositesps1_1","text":"","title":"Export-SPOSites.ps1"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#october-27-2021-0586751","text":"Initial release","title":"October 27, 2021 (0586751)"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#update-bulkpropertybagvaluesps1_1","text":"","title":"Update-BulkPropertyBagValues.ps1"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#january-14-2022-8394ccd","text":"Updated with new PnP cmdlet and module version check","title":"January 14, 2022 (8394ccd)"},{"location":"spo-od/adaptive-scopes-propertybag-scripts/#october-27-2021-0586751_1","text":"Initial release","title":"October 27, 2021 (0586751)"}]}